<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Brevity</title>
    <link rel="stylesheet" href="brevity.css">
</head>

<body>
    <h1 id="page-title"></h1>
    <div id="data-error" class="data-error" hidden></div>
    <div class="container">
        <!-- WEATHER -->
        <div class="section">
            <h2 style="border-bottom: 2px solid #1da1f2; color: #ffffff;">Weather (Copenhagen)</h2>
            <div id="weather-content">
            
            </div>
        </div>

        <!-- MARKETS -->
        <div class="section">
            <h2
                style="border-bottom: 2px solid #ffffff; color: #ffffff; display: flex; justify-content: space-between; align-items: baseline;">
                Markets <span id="markets-average"
                    style="font-size: 1.25em; font-weight: bold; font-family: 'Courier New', monospace; color: #aaa;"></span></h2>
            <div id="markets-content">
            
            </div>
        </div>
    </div>

    <!-- WORDS OF JESUS -->
    <div class="container section-gap">
        <div class="section full-width">
            <div id="jesus-quote-content">
            
            </div>
        </div>
    </div>

    <!-- X TRENDING (Full Width Middle Section) -->
    <!-- Using a new container for full width -->
    <div class="container" style="margin-top: 10px; margin-bottom: 10px;">
        <div class="section full-width" style="width: 100%;">
            <h2 style="border-bottom: 2px solid #868686; color: #ffffff;">
                Trending on X
                
                <button class="refresh-button" type="button" data-section="x_trending"
                    aria-label="Refresh Trending on X" title="Refresh Trending on X">‚ü≥</button>
                
            </h2>

            <div id="x-trending-content">
            
            </div>
        </div>
    </div>

    <!-- BOTTOM ROW: Copenhagen | Space News -->
    <div class="columns">
        <div class="column column-left">
            <div class="section column-section" style="--section-accent: #f21d1d;">
            <h2 style="border-bottom: 2px solid #f21d1d; color: #ffffff;">Copenhagen Today</h2>
            <div id="copenhagen-content">
            
            </div>

        </div>
        </div>

        <!-- RIGHT: World News -->
        <div class="column column-right">
            <div class="section column-section" style="--section-accent: #ffffff;">
            <h2 style="border-bottom: 2px solid #ffffff; color: #ffffff;">Space News</h2>
            <div id="space-news-content">
            
            </div>
            </div>
        </div>
    </div>

    <!-- WORLD NEWS (Full Width) -->
    <div class="container" style="margin-top: 10px; margin-bottom: 10px;">
        <div class="section full-width" style="--section-accent: #0048ff;">
            <h2 style="border-bottom: 2px solid #0048ff; color: #ffffff;">World News</h2>
            <div id="world-news-content">
            
            </div>
        </div>
    </div>


    <!-- Quote of the Day -->
    <div id="quote-content">
        
    </div>

    
    <script>
        (() => {
            const isFileProtocol = window.location.protocol === "file:";
            const baseUrl = (!isFileProtocol && window.location.origin) ? `${window.location.origin}/` : window.location.href;
            const DATA_URL = new URL("resources/brevity.json", baseUrl).toString();
            const REFRESH_X_URL = new URL("/api/refresh/x", baseUrl).toString();
            const headerEl = document.getElementById("page-title");
            const marketsAvgEl = document.getElementById("markets-average");
            const errorEl = document.getElementById("data-error");
            const sections = {
                weather: document.getElementById("weather-content"),
                markets: document.getElementById("markets-content"),
                jesus_quote: document.getElementById("jesus-quote-content"),
                x_trending: document.getElementById("x-trending-content"),
                copenhagen: document.getElementById("copenhagen-content"),
                space_news: document.getElementById("space-news-content"),
                world_news: document.getElementById("world-news-content"),
                quote: document.getElementById("quote-content"),
            };

            const categoryColors = {
                "Science": "#9b59b6",
                "Tech": "#3498db",
                "World News": "#e74c3c",
                "World Politics": "#e67e22",
                "Copenhagen / Denmark": "#ff0000",
                "Misc": "#95a5a6"
            };

            const toNumber = (value) => {
                const num = Number(value);
                return Number.isFinite(num) ? num : 0;
            };

            const formatNumber = (value, digits) => toNumber(value).toFixed(digits);

            const formatTime = (value) => {
                if (!value) {
                    return "";
                }
                const parts = String(value).split("T");
                if (parts.length < 2) {
                    return "";
                }
                return parts[1].slice(0, 5);
            };

            const showError = (message) => {
                if (!errorEl) {
                    return;
                }
                errorEl.textContent = message;
                errorEl.hidden = false;
            };

            const clearError = () => {
                if (!errorEl) {
                    return;
                }
                errorEl.textContent = "";
                errorEl.hidden = true;
            };

            const loadData = async () => {
                const response = await fetch(`${DATA_URL}?t=${Date.now()}`, { cache: "no-store" });
                if (!response.ok) {
                    throw new Error(`Failed to load ${DATA_URL}`);
                }
                return response.json();
            };

            const refreshXTrends = async () => {
                if (isFileProtocol) {
                    throw new Error("Refresh requires a local server.");
                }
                if (!REFRESH_X_URL) {
                    return;
                }
                const response = await fetch(REFRESH_X_URL, { method: "POST" });
                if (!response.ok) {
                    throw new Error("Failed to refresh X trends");
                }
                const payload = await response.json().catch(() => ({}));
                if (payload.status && payload.status !== "ok") {
                    throw new Error("Failed to refresh X trends");
                }
            };

            const renderHeader = (data) => {
                if (!headerEl) {
                    return;
                }
                const yearPercent = formatNumber(data?.year_percent, 1);
                headerEl.textContent = `${data?.date || ""} | ${yearPercent}%`;
            };

            const renderWeather = (weather) => {
                if (!weather) {
                    return (
                        '<div class="weather-item full-width" style="text-align: center; color: #f44336; font-weight: bold;">' +
                        "ERROR: Weather data unavailable" +
                        "</div>"
                    );
                }
                const segment = (label, data) => {
                    const windSize = 18 + (toNumber(data?.wind) * 0.8);
                    return `
                        <div class="weather-item">
                            <div style="font-size: 14px; margin-bottom: 2px; color: white;">${label}</div>
                            <div class="weather-icon">${data?.icon || ""}</div>
                            <div class="weather-value">${data?.temp ?? ""}¬∞C</div>
                            <div class="weather-label">
                                <span class="wind-arrow" style="transform: rotate(${toNumber(data?.wind_dir)}deg); font-size: ${windSize}px;">‚¨á</span>
                                <div class="wind-speed">${toNumber(data?.wind)} km/h</div>
                            </div>
                        </div>
                    `;
                };
                return `
                    <div class="weather-grid">
                        ${segment("Morning", weather.morning)}
                        ${segment("Afternoon", weather.afternoon)}
                        ${segment("Evening", weather.evening)}
                        <div class="weather-item full-width weather-meta">
                            <div class="weather-meta-item">
                                <span class="weather-meta-icon">üåÖ</span>
                                <span class="weather-meta-text">${formatTime(weather.sunrise)}</span>
                            </div>
                            <div class="weather-meta-item">
                                <span class="weather-meta-icon">üåá</span>
                                <span class="weather-meta-text">${formatTime(weather.sunset)}</span>
                            </div>
                            <div class="weather-meta-item">
                                <span class="weather-meta-icon">üåßÔ∏è</span>
                                <span class="weather-meta-text">${toNumber(weather.daily_precip)}%</span>
                            </div>
                        </div>
                    </div>
                `;
            };

            const renderMarkets = (stocks) => {
                if (!stocks || typeof stocks !== "object") {
                    return "";
                }
                const avg = toNumber(stocks.average_percent);
                if (marketsAvgEl) {
                    marketsAvgEl.textContent = `${formatNumber(avg, 2)}%`;
                    marketsAvgEl.style.color = avg >= 0 ? "green" : "red";
                }
                const entries = Object.entries(stocks).filter(([name]) => name !== "average_percent");
                return entries.map(([name, data]) => {
                    const price = formatNumber(data?.price, 2);
                    const percent = formatNumber(data?.percent, 2);
                    const color = data?.color || "grey";
                    return `
                        <div class="stock-item">
                            <span class="stock-name">${name}</span>
                            <span class="stock-price ${color}">
                                ${price} : <span style="font-size: 1.2em; font-weight: bold;">${percent}%</span>
                            </span>
                        </div>
                    `;
                }).join("");
            };

            const renderNewsItems = (items, includeInlineStyle = true) => {
                return items.map((item) => {
                    const link = item?.link || "#";
                    const headline = item?.headline || "";
                    const styleAttr = includeInlineStyle ? ' style="text-decoration: none; border: none;"' : "";
                    return `
                        <div class="news-item">
                            <div class="news-title"><a href="${link}" target="_blank"${styleAttr}>${headline}</a></div>
                        </div>
                    `;
                }).join("");
            };

            const renderNewsList = (items) => {
                if (!Array.isArray(items) || items.length === 0) {
                    return `
                        <div class="news-item">
                            <div class="news-summary" style="font-style: italic; color: #888;">Null</div>
                        </div>
                    `;
                }
                return renderNewsItems(items);
            };

            const renderWorldNews = (items) => {
                if (!Array.isArray(items) || items.length === 0) {
                    return `
                        <div class="news-item">
                            <div class="news-summary" style="font-style: italic; color: #888;">Null</div>
                        </div>
                    `;
                }
                const left = items.slice(0, 5);
                const right = items.slice(5, 10);
                return `
                    <div class="world-grid">
                        <div class="world-column">
                            ${renderNewsItems(left, false)}
                        </div>
                        <div class="world-column">
                            ${renderNewsItems(right, false)}
                        </div>
                    </div>
                `;
            };

            const renderXTrending = (xTrending) => {
                if (!Array.isArray(xTrending) || xTrending.length === 0) {
                    return `
                        <div class="news-item">
                            <div class="news-summary" style="font-style: italic; color: #888;">Null</div>
                        </div>
                    `;
                }
                const blocks = xTrending.map((entry) => {
                    const category = Array.isArray(entry) ? entry[0] : entry?.category;
                    const trends = Array.isArray(entry) ? entry[1] : entry?.trends;
                    const color = categoryColors[category] || "#888";
                    const border = categoryColors[category] || "#1da1f2";
                    const items = Array.isArray(trends) ? trends : [];
                    const trendsHtml = items.length ? items.map((item) => {
                        const since = item?.trending_since;
                        return `
                            <div class="news-item" style="border-left: 2px solid ${border};">
                                <div class="news-title">
                                    <a href="${item?.link || "#"}" target="_blank" style="text-decoration: none; border: none;">${item?.name || ""}</a>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 3px;">
                                    <div style="font-size: 10px; color: #666;">${item?.post_count ?? "N/A"} posts</div>
                                    ${since ? `<div style="font-size: 9px; color: #555;">Since ${since}</div>` : ""}
                                </div>
                            </div>
                        `;
                    }).join("") : `
                        <div class="news-item" style="border-left: 2px solid #333;">
                            <div class="news-summary" style="font-style: italic; color: #666; font-size: 11px;">Nothing trending</div>
                        </div>
                    `;
                    return `
                        <div style="break-inside: avoid;">
                            <div style="font-size: 15px; color: ${color}; font-weight: bold; margin-bottom: 6px; letter-spacing: 0.5px;">${category || ""}</div>
                            ${trendsHtml}
                        </div>
                    `;
                }).join("");
                return `<div class="x-grid">${blocks}</div>`;
            };

            const renderJesusQuote = (quote) => {
                if (!quote) {
                    return "";
                }
                return `
                    <h2 class="jesus-title">Words of Jesus</h2>
                    <div class="jesus-card">
                        <div class="jesus-quote-text">${quote.text || ""}</div>
                        <div class="jesus-quote-ref">${quote.author || ""}</div>
                    </div>
                `;
            };

            const renderQuote = (quote) => {
                if (!quote) {
                    return "";
                }
                return `
                    <div style="text-align: center; margin-bottom: 25px; padding: 20px; background-color: #222; border-radius: 15px; border-left: 6px solid #ffee00; border-right: 6px solid #ffee00;">
                        <div style="font-family: 'Georgia', serif; font-style: italic; font-size: 18px; margin-bottom: 8px; color: #ddd;">
                            ${quote.text || ""}
                        </div>
                        <div style="font-size: 12px; font-weight: bold; text-transform: uppercase; color: #ffee00; letter-spacing: 1px;">
                            ${quote.author || ""}
                        </div>
                    </div>
                `;
            };

            const renderAll = (data) => {
                renderHeader(data);
                if (sections.weather) {
                    sections.weather.innerHTML = renderWeather(data?.weather);
                }
                if (sections.markets) {
                    sections.markets.innerHTML = renderMarkets(data?.stocks);
                }
                if (sections.jesus_quote && data?.jesus_quote) {
                    sections.jesus_quote.innerHTML = renderJesusQuote(data?.jesus_quote);
                }
                if (sections.x_trending) {
                    sections.x_trending.innerHTML = renderXTrending(data?.x_trending);
                }
                if (sections.copenhagen) {
                    sections.copenhagen.innerHTML = renderNewsList(data?.copenhagen);
                }
                if (sections.space_news) {
                    sections.space_news.innerHTML = renderNewsList(data?.space_news);
                }
                if (sections.world_news) {
                    sections.world_news.innerHTML = renderWorldNews(data?.world_news);
                }
                if (sections.quote) {
                    sections.quote.innerHTML = renderQuote(data?.quote);
                }
            };

            const renderSection = (section, data) => {
                if (section === "x_trending" && sections.x_trending) {
                    sections.x_trending.innerHTML = renderXTrending(data?.x_trending);
                } else if (section === "weather" && sections.weather) {
                    sections.weather.innerHTML = renderWeather(data?.weather);
                } else if (section === "markets" && sections.markets) {
                    sections.markets.innerHTML = renderMarkets(data?.stocks);
                } else if (section === "jesus_quote" && sections.jesus_quote && data?.jesus_quote) {
                    sections.jesus_quote.innerHTML = renderJesusQuote(data?.jesus_quote);
                } else if (section === "copenhagen" && sections.copenhagen) {
                    sections.copenhagen.innerHTML = renderNewsList(data?.copenhagen);
                } else if (section === "space_news" && sections.space_news) {
                    sections.space_news.innerHTML = renderNewsList(data?.space_news);
                } else if (section === "world_news" && sections.world_news) {
                    sections.world_news.innerHTML = renderWorldNews(data?.world_news);
                } else if (section === "quote" && sections.quote) {
                    sections.quote.innerHTML = renderQuote(data?.quote);
                } else {
                    renderAll(data);
                }
            };

            const refreshSection = async (section, button) => {
                if (button) {
                    button.disabled = true;
                    button.classList.add("is-loading");
                }
                try {
                    if (section === "x_trending") {
                        await refreshXTrends();
                    }
                    const data = await loadData();
                    renderSection(section, data);
                    clearError();
                } catch (err) {
                    showError("Could not refresh data. Serve this folder via a local web server and try again.");
                } finally {
                    if (button) {
                        button.disabled = false;
                        button.classList.remove("is-loading");
                    }
                }
            };

            document.querySelectorAll(".refresh-button").forEach((button) => {
                button.addEventListener("click", () => refreshSection(button.dataset.section, button));
            });

            loadData()
                .then((data) => {
                    renderAll(data);
                    clearError();
                })
                .catch(() => {
                    showError("Could not load data file. Serve this folder via a local web server and try again.");
                });
        })();
    </script>
    

</body>

</html>